---
// Floating Buttons with AI Chatbot
---

<!-- Floating Action Buttons - Horizontal Layout -->
<div class="fixed bottom-24 md:bottom-6 right-6 z-50 flex items-center gap-3">
    <!-- WhatsApp Button -->
    <a
        href="https://wa.me/51951129150?text=Hola,%20me%20gustarÃ­a%20solicitar%20informaciÃ³n"
        target="_blank"
        rel="noopener noreferrer"
        class="group flex items-center gap-2 px-4 py-3 bg-[#25D366] hover:bg-[#20BA5A] text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105"
        aria-label="Contactar por WhatsApp"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="currentColor"
        >
            <path
                d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"
            ></path>
        </svg>
        <span class="font-medium hidden sm:inline">WhatsApp</span>
    </a>

    <!-- AI Chatbot Button -->
    <button
        id="chatbot-toggle"
        class="group flex items-center gap-2 px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 animate-pulse"
        aria-label="Abrir Asistente Virtual"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
        >
            <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
            ></path>
        </svg>
        <span class="font-medium hidden sm:inline">Chat</span>
    </button>
</div>

<!-- AI Chatbot Modal -->
<div
    id="chatbot-modal"
    class="fixed inset-0 md:inset-auto md:bottom-24 md:right-6 z-50 md:w-96 md:max-w-[calc(100vw-3rem)] bg-neutral-900 border-0 md:border md:border-neutral-700 md:rounded-2xl shadow-2xl opacity-0 scale-95 pointer-events-none transition-all duration-300"
>
    <!-- Header -->
    <div
        class="bg-gradient-to-r from-emerald-600 to-emerald-500 p-4 md:rounded-t-2xl flex items-center justify-between"
    >
        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    class="text-white"
                >
                    <path d="M12 8V4H8"></path>
                    <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                    <path d="M2 14h2"></path>
                    <path d="M20 14h2"></path>
                    <path d="M15 13v2"></path>
                    <path d="M9 13v2"></path>
                </svg>
            </div>
            <div>
                <h3 class="font-bold text-white">Asistente Virtual</h3>
                <p class="text-xs text-white/80">Respuestas instantÃ¡neas</p>
            </div>
        </div>
        <button
            id="chatbot-close"
            class="text-white/80 hover:text-white transition-colors"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
            >
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Chat Messages -->
    <div
        id="chat-messages"
        class="flex-1 md:h-96 overflow-y-scroll p-4 space-y-4 bg-black/30"
        style="overscroll-behavior: contain;"
    >
        <!-- Welcome Message -->
        <div class="flex gap-3">
            <div
                class="w-8 h-8 rounded-full bg-emerald-600 flex-shrink-0 flex items-center justify-center"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    class="text-white"
                >
                    <path d="M12 8V4H8"></path>
                    <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                </svg>
            </div>
            <div class="flex-1">
                <div
                    class="bg-neutral-800 rounded-2xl rounded-tl-none p-3 text-sm text-neutral-200"
                >
                    Â¡Hola! ğŸ‘‹ Soy el asistente virtual de Ecofamil. Â¿En quÃ©
                    puedo ayudarte hoy?
                </div>
                <p class="text-xs text-neutral-500 mt-1">Ahora</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="p-3 bg-neutral-900/50 border-t border-neutral-700">
        <p class="text-xs text-neutral-400 mb-2">Respuestas rÃ¡pidas:</p>
        <div class="flex flex-wrap gap-2">
            <button
                class="quick-action px-3 py-1.5 text-xs bg-neutral-800 hover:bg-emerald-600/20 text-neutral-300 hover:text-emerald-400 rounded-full border border-neutral-700 hover:border-emerald-600/30 transition-all"
                data-message="Â¿QuÃ© servicios ofrecen?"
            >
                ğŸ”§ Servicios
            </button>
            <button
                class="quick-action px-3 py-1.5 text-xs bg-neutral-800 hover:bg-emerald-600/20 text-neutral-300 hover:text-emerald-400 rounded-full border border-neutral-700 hover:border-emerald-600/30 transition-all"
                data-message="Â¿CuÃ¡les son sus horarios?"
            >
                ğŸ• Horarios
            </button>
            <button
                class="quick-action px-3 py-1.5 text-xs bg-neutral-800 hover:bg-emerald-600/20 text-neutral-300 hover:text-emerald-400 rounded-full border border-neutral-700 hover:border-emerald-600/30 transition-all"
                data-message="Quiero una cotizaciÃ³n"
            >
                ğŸ’° CotizaciÃ³n
            </button>
        </div>
    </div>

    <!-- Input -->
    <div class="p-4 border-t border-neutral-700">
        <form id="chat-form" class="flex gap-2">
            <input
                type="text"
                id="chat-input"
                placeholder="Escribe tu mensaje..."
                class="flex-1 px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-full text-sm text-white placeholder-neutral-500 focus:outline-none focus:border-emerald-600/50 transition-colors"
            />
            <button
                type="submit"
                class="w-10 h-10 rounded-full bg-emerald-600 hover:bg-emerald-500 flex items-center justify-center transition-colors"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    class="text-white"
                >
                    <path d="m22 2-7 20-4-9-9-4Z"></path>
                    <path d="M22 2 11 13"></path>
                </svg>
            </button>
        </form>
    </div>
</div>

<script>
    // Chatbot functionality - Static version
    const toggle = document.getElementById("chatbot-toggle");
    const close = document.getElementById("chatbot-close");
    const modal = document.getElementById("chatbot-modal");
    const chatMessages = document.getElementById("chat-messages");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input") as HTMLInputElement;
    const quickActions = document.querySelectorAll(".quick-action");

    // Conversation history for context
    let conversationHistory: Array<{ role: string; content: string }> = [];

    // Add typing indicator
    function showTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.id = "typing-indicator";
        typingDiv.className = "flex gap-3 animate-fade-in";
        typingDiv.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-emerald-600 flex-shrink-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-white">
                    <path d="M12 8V4H8"/>
                    <rect width="16" height="12" x="4" y="8" rx="2"/>
                </svg>
            </div>
            <div class="flex-1">
                <div class="bg-neutral-800 rounded-2xl rounded-tl-none p-3 text-sm text-neutral-200">
                    <div class="flex gap-1">
                        <span class="animate-bounce" style="animation-delay: 0ms">â—</span>
                        <span class="animate-bounce" style="animation-delay: 150ms">â—</span>
                        <span class="animate-bounce" style="animation-delay: 300ms">â—</span>
                    </div>
                </div>
            </div>
        `;
        chatMessages?.appendChild(typingDiv);
        chatMessages!.scrollTop = chatMessages!.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById("typing-indicator");
        indicator?.remove();
    }

    // Intelligent static response system
    function getResponse(userMessage: string): string {
        const msg = userMessage.toLowerCase().trim();

        // Servicios
        if (
            msg.includes("servicio") ||
            msg.includes("quÃ© hacen") ||
            msg.includes("quÃ© ofrecen")
        ) {
            return "Â¡Claro! En **Ecofamil** somos expertos en gestiÃ³n ambiental:\n\n**ğŸ—‘ï¸ GestiÃ³n Integral de Residuos**\nRecolecciÃ³n, transporte y disposiciÃ³n final\n\n**ğŸ§¹ Limpieza Industrial**\nEspecializada para minerÃ­a e industria\n\n**ğŸš› Transporte Especializado**\nFlota certificada\n\n**ğŸ—ï¸ Rellenos Sanitarios**\nOperaciÃ³n profesional\n\n**ğŸš» BaÃ±os PortÃ¡tiles**\nAlquiler y mantenimiento\n\nÂ¿Te gustarÃ­a saber mÃ¡s sobre algÃºn servicio?";
        }

        // Residuos
        if (
            msg.includes("residuo") ||
            msg.includes("basura") ||
            msg.includes("desecho") ||
            msg.includes("reciclaje")
        ) {
            return "Nuestra **GestiÃ³n de Residuos** incluye:\n\nğŸ“¦ **RecolecciÃ³n y SegregaciÃ³n**\nâ€¢ Residuos peligrosos y no peligrosos\nâ€¢ ClasificaciÃ³n profesional\n\nğŸš› **Transporte Certificado**\nâ€¢ Flota moderna\nâ€¢ Personal capacitado\n\nğŸ”„ **DisposiciÃ³n Final**\nâ€¢ Reciclaje y valorizaciÃ³n\nâ€¢ Certificados incluidos\n\nÂ¿Necesitas una cotizaciÃ³n?";
        }

        // Limpieza
        if (
            msg.includes("limpieza") ||
            msg.includes("limpiar") ||
            msg.includes("industrial")
        ) {
            return "**Limpieza Industrial Especializada** ğŸ§¹\n\nğŸ­ **Para:**\nâ€¢ Plantas mineras\nâ€¢ Instalaciones industriales\nâ€¢ Maquinaria pesada\n\nâš™ï¸ **Con:**\nâ€¢ Equipos de alta presiÃ³n\nâ€¢ Personal capacitado\nâ€¢ Protocolos de seguridad\n\nâ° **Disponibles 24/7**\n\nğŸ“ LlÃ¡manos: 951 129 150";
        }

        // BaÃ±os portÃ¡tiles
        if (
            msg.includes("baÃ±o") ||
            msg.includes("portÃ¡til") ||
            msg.includes("sanitario")
        ) {
            return "**BaÃ±os PortÃ¡tiles** ğŸš»\n\nâœ… **Para:**\nâ€¢ Obras y construcciones\nâ€¢ Eventos\nâ€¢ Campamentos mineros\n\nğŸ’ª **Incluye:**\nâ€¢ InstalaciÃ³n y retiro\nâ€¢ Limpieza regular\nâ€¢ Suministros\n\nğŸ’° Tarifas flexibles (dÃ­a/semana/mes)\n\nÂ¿CuÃ¡ntas unidades necesitas?";
        }

        // Precios/CotizaciÃ³n
        if (
            msg.includes("precio") ||
            msg.includes("cuÃ¡nto") ||
            msg.includes("cotiz") ||
            msg.includes("costo")
        ) {
            return "Para una **cotizaciÃ³n exacta** necesito conocer:\n\nğŸ“‹ Â¿QuÃ© servicio necesitas?\nğŸ“ Â¿UbicaciÃ³n?\nğŸ“… Â¿Frecuencia?\n\nğŸ’¼ **ContÃ¡ctanos:**\nğŸ“ 951 129 150\nğŸ’¬ WhatsApp (botÃ³n verde)\nğŸ“§ info@ecofamil.com\n\nâ±ï¸ Respuesta en menos de 2 horas";
        }

        // Contacto
        if (
            msg.includes("contacto") ||
            msg.includes("llamar") ||
            msg.includes("ubicaciÃ³n") ||
            msg.includes("direcciÃ³n") ||
            msg.includes("dÃ³nde")
        ) {
            return "ğŸ“± **ContÃ¡ctanos:**\n\nğŸ“ **TelÃ©fonos:**\nâ€¢ 951 129 150\nâ€¢ 957 701 113\nâ€¢ 965 125 703\n\nğŸ’¬ **WhatsApp:** 951 129 150\n\nğŸ“§ **Email:** info@ecofamil.com\n\nğŸ“ **Oficina:**\nCalle Suycutambo S/N\nEspinar, Cusco\n\nğŸ• Lun-Vie: 8AM-6PM\nSÃ¡b: 8AM-1PM\nğŸš¨ Emergencias 24/7";
        }

        // Horarios
        if (
            msg.includes("horario") ||
            msg.includes("cuÃ¡ndo") ||
            msg.includes("abierto")
        ) {
            return "ğŸ“… **Horarios:**\n\n**Oficina:**\nğŸ• Lun-Vie: 8:00 AM - 6:00 PM\nğŸ• SÃ¡bados: 8:00 AM - 1:00 PM\n\n**Emergencias:** ğŸš¨\nâš¡ Disponibles 24/7\nğŸ“ 951 129 150\n\nÂ¿Necesitas programar un servicio?";
        }

        // Urgencia
        if (
            msg.includes("urgente") ||
            msg.includes("emergencia") ||
            msg.includes("rÃ¡pido") ||
            msg.includes("ya")
        ) {
            return "ğŸš¨ **Â¡Entendemos tu urgencia!**\n\nâš¡ **LlÃ¡manos AHORA:**\nğŸ“ 951 129 150\n\nğŸ’¬ **O WhatsApp:**\nClick en el botÃ³n verde ğŸ‘‰\n\nâœ… Disponibles 24/7\nâœ… Respuesta en minutos\nâœ… Servicio el mismo dÃ­a\n\nÂ¿CuÃ¡l es tu emergencia?";
        }

        // Saludo
        if (
            msg.includes("hola") ||
            msg.includes("buenas") ||
            msg.includes("buenos dÃ­as") ||
            msg.includes("hey")
        ) {
            return "Â¡Hola! ğŸ‘‹ Bienvenido a **Ecofamil**\n\nEstoy aquÃ­ para ayudarte con:\n\nğŸ—‘ï¸ GestiÃ³n de residuos\nğŸ§¹ Limpieza industrial\nğŸš» BaÃ±os portÃ¡tiles\nğŸ’¼ Cotizaciones\nğŸ“ InformaciÃ³n de contacto\n\nÂ¿En quÃ© puedo ayudarte?";
        }

        // Agradecimiento
        if (
            msg.includes("gracias") ||
            msg.includes("excelente") ||
            msg.includes("perfecto") ||
            msg.includes("genial")
        ) {
            return "Â¡De nada! ğŸ˜Š\n\nSi necesitas mÃ¡s informaciÃ³n:\n\nğŸ“ 951 129 150\nğŸ’¬ WhatsApp disponible\nğŸ“§ info@ecofamil.com\n\nÂ¿Hay algo mÃ¡s en lo que pueda ayudarte?";
        }

        // Default
        return "Entiendo tu consulta. Para brindarte la mejor informaciÃ³n:\n\n**Servicios principales:**\nğŸ—‘ï¸ GestiÃ³n de Residuos\nğŸ§¹ Limpieza Industrial\nğŸš» BaÃ±os PortÃ¡tiles\n\nğŸ“ **ContÃ¡ctanos:**\nâ€¢ Tel: 951 129 150\nâ€¢ WhatsApp: BotÃ³n verde\nâ€¢ Email: info@ecofamil.com\n\nÂ¿Sobre quÃ© servicio te gustarÃ­a saber mÃ¡s?";
    }

    function addMessage(message: string, isUser: boolean) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex gap-3 animate-fade-in";

        if (isUser) {
            messageDiv.innerHTML = `
                <div class="flex-1"></div>
                <div class="flex-1">
                    <div class="bg-emerald-600 rounded-2xl rounded-tr-none p-3 text-sm text-white ml-auto">
                        ${message}
                    </div>
                    <p class="text-xs text-neutral-500 mt-1 text-right">Ahora</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-neutral-700 flex-shrink-0 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-white">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
            `;
            // Add to history
            conversationHistory.push({ role: "user", content: message });
        } else {
            // Simple formatting for bot messages (bold and line breaks)
            const formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") // **bold** â†’ <strong>bold</strong>
                .replace(/\n/g, "<br>"); // Line breaks

            messageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-emerald-600 flex-shrink-0 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-white">
                        <path d="M12 8V4H8"/>
                        <rect width="16" height="12" x="4" y="8" rx="2"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="bg-neutral-800 rounded-2xl rounded-tl-none p-3 text-sm text-neutral-200">
                        ${formattedMessage}
                    </div>
                    <p class="text-xs text-neutral-500 mt-1">Ahora</p>
                </div>
            `;
            // Add to history
            conversationHistory.push({ role: "assistant", content: message });
        }

        chatMessages?.appendChild(messageDiv);
        chatMessages!.scrollTop = chatMessages!.scrollHeight;

        // Keep history limited to last 20 messages
        if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
        }
    }

    // Toggle modal
    toggle?.addEventListener("click", () => {
        modal?.classList.remove("opacity-0", "scale-95", "pointer-events-none");
        modal?.classList.add("opacity-100", "scale-100");
        chatInput?.focus();
    });

    close?.addEventListener("click", () => {
        modal?.classList.add("opacity-0", "scale-95", "pointer-events-none");
        modal?.classList.remove("opacity-100", "scale-100");
    });

    // Prevent scroll propagation from chat to page
    chatMessages?.addEventListener("wheel", (e) => {
        const target = e.currentTarget as HTMLElement;
        const atTop = target.scrollTop === 0;
        const atBottom =
            target.scrollHeight - target.scrollTop === target.clientHeight;

        // Prevent page scroll when scrolling inside chat
        if (
            (e.deltaY < 0 && !atTop) || // Scrolling up and not at top
            (e.deltaY > 0 && !atBottom) // Scrolling down and not at bottom
        ) {
            e.stopPropagation();
        }
    });

    // Handle form submission with AI
    chatForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const message = chatInput?.value.trim();

        if (message) {
            // Add user message
            addMessage(message, true);
            chatInput!.value = "";

            // Show typing indicator
            showTypingIndicator();

            // Get AI response
            const response = getResponse(message);

            // Remove typing indicator and show response
            removeTypingIndicator();
            addMessage(response, false);
        }
    });

    // Quick action buttons with AI
    quickActions.forEach((btn) => {
        btn.addEventListener("click", async () => {
            const message = btn.getAttribute("data-message");
            if (message) {
                addMessage(message, true);

                // Show typing indicator
                showTypingIndicator();

                // Get AI response
                const response = getResponse(message);

                // Remove typing indicator and show response
                removeTypingIndicator();
                addMessage(response, false);
            }
        });
    });
</script>

<style>
    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }

    /* Custom scrollbar */
    #chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    #chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    #chat-messages::-webkit-scrollbar-thumb {
        background: #404040;
        border-radius: 3px;
    }

    #chat-messages::-webkit-scrollbar-thumb:hover {
        background: #525252;
    }

    /* Markdown styles for bot messages */
    #chat-messages .prose {
        color: #e5e5e5;
    }

    #chat-messages .prose strong {
        color: #ffffff;
        font-weight: 700;
    }

    #chat-messages .prose p {
        margin: 0.5em 0;
    }

    #chat-messages .prose p:first-child {
        margin-top: 0;
    }

    #chat-messages .prose p:last-child {
        margin-bottom: 0;
    }

    #chat-messages .prose ul,
    #chat-messages .prose ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
    }

    #chat-messages .prose li {
        margin: 0.25em 0;
    }

    #chat-messages .prose code {
        background: rgba(52, 211, 153, 0.1);
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
        color: #34d399;
    }

    #chat-messages .prose a {
        color: #34d399;
        text-decoration: underline;
    }

    #chat-messages .prose a:hover {
        color: #10b981;
    }
</style>
